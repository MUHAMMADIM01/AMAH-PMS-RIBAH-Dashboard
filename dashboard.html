<!DOCTYPE html>
<html>
<head>
<title>Amah Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<h2>Amah Medicine Store â€” Dashboard</h2>
<button onclick="logout()">Logout</button>

<hr>

<h3>Add Medicine</h3>
<input id="mName" placeholder="Medicine Name">
<input id="mPrice" placeholder="Price">
<textarea id="mDesc" placeholder="Description"></textarea>
<input type="file" id="mPhoto">
<button onclick="addMedicine()">Add</button>

<h3>Medicine List</h3>
<div id="medContainer"></div>

<hr>

<h3>Add Health Tip</h3>
<input id="tipText" placeholder="Tip...">
<button onclick="addTip()">Add Tip</button>

<h3>Tips List</h3>
<div id="tipContainer"></div>

<script type="module" src="firebase.js"></script>

<script type="module">
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  import {
    collection, addDoc, getDocs, deleteDoc, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  import {
    ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

  // â›” Dashboard Protection
  onAuthStateChanged(auth, user => {
    if (!user) {
      localStorage.setItem("isLoggedIn", "false");
      location.href = "login.html";
    }
  });

  // ðŸ”“ Logout
  window.logout = function () {
    signOut(auth).then(() => {
      localStorage.clear();
      location.href = "login.html";
    });
  };

  // âž• Add Medicine
  window.addMedicine = async function () {
    const name = mName.value;
    const price = mPrice.value;
    const desc = mDesc.value;
    const file = mPhoto.files[0];

    if (!name || !price) return alert("Enter name & price");

    let imageURL = "";

    if (file) {
      const storageRef = ref(storage, "medicines/" + Date.now());
      await uploadBytes(storageRef, file);
      imageURL = await getDownloadURL(storageRef);
    }

    await addDoc(collection(db, "medicines"), {
      name, price, desc, imageURL
    });

    loadMedicines();
  };

  // ðŸ“¥ Load Medicines
  async function loadMedicines() {
    const snap = await getDocs(collection(db, "medicines"));
    medContainer.innerHTML = "";

    snap.forEach(docu => {
      const d = docu.data();

      medContainer.innerHTML += `
        <div class='card'>
          <img src="${d.imageURL}" height="80"><br>
          <b>${d.name}</b> - â‚¦${d.price}<br>
          ${d.desc}<br>

          <button onclick="deleteMed('${docu.id}')">Delete</button>
        </div>
      `;
    });
  }
  window.deleteMed = async function (id) {
    await deleteDoc(doc(db, "medicines", id));
    loadMedicines();
  };

  // âž• Add Tip
  window.addTip = async function () {
    const text = tipText.value;
    if (!text) return alert("Enter tip");

    await addDoc(collection(db, "tips"), { text });
    loadTips();
  };

  async function loadTips() {
    const snap = await getDocs(collection(db, "tips"));
    tipContainer.innerHTML = "";

    snap.forEach(docu => {
      const d = docu.data();

      tipContainer.innerHTML += `
        <div class='card'>
          ${d.text}
          <button onclick="deleteTip('${docu.id}')">Delete</button>
        </div>
      `;
    });
  }
  window.deleteTip = async function (id) {
    await deleteDoc(doc(db, "tips", id));
    loadTips();
  };

  loadMedicines();
  loadTips();
</script>

</body>
</html>
